# At least this version of direnv is required.
direnv version 2.37.1

if ! has mise; then
    log_error "Command mise must be installed to work with this repository!
Please install mise following the instructions on https://mise.jdx.dev.
If you worked with this repo before using Nix â€” feel free to remove Nix if you don't need it for anything else.
Nix is dead, long live mise!"
    exit 0
fi

mise trust -q
mise install
eval "$(mise activate bash)"
watch_file ./mise.toml

# Some necessary shit. Don't touch unless you know what you're doing.
export CGO_ENABLED="1"
export WORKSPACE="$(pwd)"
export SEED_MISE_BIN="$(which mise)"
mkdir -p plz-out
touch plz-out/go.mod
rm -rf bazel-* .bazel-cache bin

strict_env

# Asking git to rebase before pull.
# This helps avoiding nasty merge commits between local and remote branches,
# like "Merge branch 'main' of <remote>".
# The slight inconvenience is that git won't pull into a dirty workspace,
# asking to stash or commit the changes before pulling.
if [ "$(git config --get pull.rebase)" != "true" ]; then
    git config pull.rebase true
fi

# Adding .local to the equivalent of .gitignore, but not checked into the repo.
# This way coding agents which usually can't access gitignored files can still access this directory,
# which exists for them to store some intermediary context files, plans, and other relevant but ephemeral files.
PATTERN=".local"
EXCLUDE_FILE="$(git rev-parse --git-path info/exclude)"
grep -qxF "$PATTERN" "$EXCLUDE_FILE" || echo "$PATTERN" >> "$EXCLUDE_FILE"

# Needed for the Go extension in VS Code to find the right toolchain.
export GOROOT="$(go env GOROOT)"

# These variables are defined in a separate file to avoid having to invoke direnv allow
# every time we change them. The file doesn't allow any scripting for security, only variables.
dotenv .env.vars

# Optional loading of local env vars.
dotenv_if_exists .env.local
