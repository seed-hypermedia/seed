subinclude(
    "//build/rules/go:defs",
    "//build/rules/js:defs",
)

package(default_visibility = ["PUBLIC"])

go_binary(
    name = "protoc-gen-go",
    srcs = [],
    gomod = "//:gomod",
    package = "google.golang.org/protobuf/cmd/protoc-gen-go",
    workdir = "../..",
)

go_binary(
    name = "protoc-gen-go-grpc",
    srcs = [],
    gomod = "//:gomod",
    package = "google.golang.org/grpc/cmd/protoc-gen-go-grpc",
    workdir = "../..",
)

yarn_binary(
    name = "protoc-gen-es",
    yarn_deps = "//:yarn",
)

yarn_binary(
    name = "protoc-gen-connect-es",
    yarn_deps = "//:yarn",
)

yarn_binary(
    name = "graphql-codegen",
    yarn_deps = "//:yarn",
)

gomod(
    name = tag("gorun", "gomod"),
    srcs = [
        "gorun/go.mod",
        "gorun/go.sum",
    ],
    workdir = "gorun",
)

go_binary(
    name = "gorun",
    srcs = ["gorun/main.go"],
    gomod = ":" + tag("gorun", "gomod"),
    workdir = "gorun",
)


def mise_binary(name: str, bin: str = None):
    """
    Exposes a binary from mise.
    """

    if not bin:
        bin = name

    return build_rule(
        name = name,
        srcs = ["//:mise.toml"],
        outs = [name],
        binary = True,
        cmd = """
cat > $OUT <<EOF
#!/bin/sh
export MISE_OVERRIDE_CONFIG_FILENAMES="$WORKSPACE/mise.toml"
exec $SEED_MISE_BIN x $target_binary -- $target_binary $(echo '$@')
EOF
""",
        env = {
            "target_binary": bin,
        },
        output_is_complete = True,
        visibility = ["PUBLIC"],
    )

# Custom cmake wrapper - uses version directly to avoid mise.toml trust issues
build_rule(
    name = "cmake",
    outs = ["cmake"],
    binary = True,
    cmd = """
cat > $OUT <<'EOF'
#!/bin/sh
# Ignore workspace config to avoid trust issues in Please sandbox
export MISE_IGNORED_CONFIG_PATHS="$WORKSPACE"
exec $SEED_MISE_BIN x cmake@3.31.6 -- cmake "$@"
EOF
""",
    output_is_complete = True,
    visibility = ["PUBLIC"],
)

mise_binary(
    name = "go"
)

mise_binary(
    name = "protoc"
)

mise_binary(
    name = "yarn"
)

mise_binary(
    name = "md5sum"
)
